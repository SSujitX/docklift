name: ðŸ§ª Verify Install Script

on:
  push:
    branches: [ "master", "main" ]
  pull_request:
    branches: [ "master", "main" ]
  workflow_dispatch:

jobs:
  test-install:
    name: ${{ matrix.name }}
    runs-on: ${{ matrix.os }}
    container: ${{ matrix.container }}
    strategy:
      fail-fast: false
      matrix:
        include:
          # Standard Ubuntu VM tests
          - name: Ubuntu 24.04
            os: ubuntu-24.04
          - name: Ubuntu 22.04
            os: ubuntu-22.04
            
          # Container Tests (Debian / CentOS compatible)
          # Note: We use an Ubuntu host but run the steps inside these containers
          - name: Debian Bookworm
            os: ubuntu-latest
            container: debian:bookworm
          - name: AlmaLinux 9 (CentOS)
            os: ubuntu-latest
            container: almalinux:9
    
    steps:
      - name: ðŸ“¥ Checkout Code
        uses: actions/checkout@v4

      - name: âš™ï¸ Install Prerequisites (Container Only)
        if: matrix.container != ''
        run: |
          # Install minimal dependencies for the script to start (curl, sudo if missing)
          if command -v apt-get &> /dev/null; then
            apt-get update && apt-get install -y curl sudo procps
          elif command -v dnf &> /dev/null; then
            dnf install -y curl sudo procps
          fi

      - name: âš™ï¸ Prepare Script
        run: chmod +x install.sh

      - name: ðŸš€ Run Install Script
        id: install
        env:
          TERM: xterm
        run: |
          # Redirect output to file to keep logs clean, but tail it if needed
          sudo -E ./install.sh

      - name: ðŸ¥ Health Check verification
        id: health
        if: success()
        run: |
          echo "â³ Waiting for services to stabilize..."
          sleep 15
          
          # 1. Check Containers
          RUNNING_CONTAINERS=$(docker ps --format "{{.Names}}" | grep docklift)
          COUNT=$(echo "$RUNNING_CONTAINERS" | wc -l)
          echo "Found $COUNT docklift containers."
          
          # 2. Check Dashboard Response
          # Using localhost:8080 as per install script config
          HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" http://localhost:8080 || echo "000")
          echo "Dashboard returned HTTP $HTTP_CODE"

          # Logic
          if [[ "$COUNT" -gt 0 ]] && [[ "$HTTP_CODE" == "200" ]]; then
            echo "status=success" >> $GITHUB_OUTPUT
            echo "containers=$COUNT" >> $GITHUB_OUTPUT
            echo "http_code=$HTTP_CODE" >> $GITHUB_OUTPUT
          else
            echo "status=failure" >> $GITHUB_OUTPUT
            echo "containers=$COUNT" >> $GITHUB_OUTPUT
            echo "http_code=$HTTP_CODE" >> $GITHUB_OUTPUT
          fi

      - name: ðŸ“Š Generate Summary Report
        if: always()
        run: |
          # Default to failure if step didn't run
          STATUS="${{ steps.health.outputs.status }}"
          [ -z "$STATUS" ] && STATUS="failure"
          
          CONTAINERS="${{ steps.health.outputs.containers }}"
          [ -z "$CONTAINERS" ] && CONTAINERS="0"
          
          HTTP="${{ steps.health.outputs.http_code }}"
          [ -z "$HTTP" ] && HTTP="N/A"
          
          echo "# ðŸ§ª Docklift Installation Test" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [[ "$STATUS" == "success" ]]; then
            echo "### âœ… Result: PASSED" >> $GITHUB_STEP_SUMMARY
            echo "Your installation script is working correctly." >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "| Check | Status | Details |" >> $GITHUB_STEP_SUMMARY
            echo "| :--- | :---: | :--- |" >> $GITHUB_STEP_SUMMARY
            echo "| **Script Execution** | âœ… | Completed without errors |" >> $GITHUB_STEP_SUMMARY
            echo "| **Docker Containers** | âœ… | $CONTAINERS containers running |" >> $GITHUB_STEP_SUMMARY
            echo "| **Web Dashboard** | âœ… | HTTP $HTTP (OK) at port 8080 |" >> $GITHUB_STEP_SUMMARY
          else
            echo "### âŒ Result: FAILED" >> $GITHUB_STEP_SUMMARY
            echo "The installation script or startup failed." >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "| Check | Status | Details |" >> $GITHUB_STEP_SUMMARY
            echo "| :--- | :---: | :--- |" >> $GITHUB_STEP_SUMMARY
            echo "| **Script Execution** | â“ | Check logs for errors |" >> $GITHUB_STEP_SUMMARY
            echo "| **Docker Containers** | ${{ steps.health.outputs.containers > 0 && 'âœ…' || 'âŒ' }} | $CONTAINERS containers found |" >> $GITHUB_STEP_SUMMARY
            echo "| **Web Dashboard** | ${{ steps.health.outputs.http_code == '200' && 'âœ…' || 'âŒ' }} | HTTP $HTTP response |" >> $GITHUB_STEP_SUMMARY
            
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### ðŸ” Debug Info" >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
            echo "Running Containers:" >> $GITHUB_STEP_SUMMARY
            docker ps --format "table {{.Names}}\t{{.Status}}" | grep docklift || echo "None" >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          fi

      - name: ðŸš¨ Fail Workflow if Check Failed
        if: steps.health.outputs.status != 'success'
        run: exit 1
