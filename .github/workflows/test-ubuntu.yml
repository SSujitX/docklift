name: Test Install - Ubuntu

on:
  push:
    branches: [ master, main ]
  pull_request:
    branches: [ master, main ]
  workflow_dispatch:

jobs:
  test-ubuntu:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Preparing System
        id: setup
        run: |
          ST=$(date +%s)
          sudo apt-get update -qq
          sudo apt-get install -y -qq curl sudo
          ET=$(date +%s)
          echo "duration=$((ET - ST))" >> $GITHUB_OUTPUT

      - name: Installing Docklift
        id: install
        run: |
          ST=$(date +%s)
          chmod +x install.sh
          sudo CI=true DOCKLIFT_CI_LOCAL=true ./install.sh 2>&1 | tee install_output.txt
          EC=${PIPESTATUS[0]}
          ET=$(date +%s)
          echo "duration=$((ET - ST))" >> $GITHUB_OUTPUT
          echo "exit_code=$EC" >> $GITHUB_OUTPUT
          exit $EC
        continue-on-error: true

      - name: Verifying Services
        id: verify
        run: |
          check_container() {
            if sudo docker ps | grep -q "$1"; then echo "âœ… Running"; else echo "âŒ Not Running"; fi
          }
          
          echo "backend_status=$(check_container docklift-backend)" >> $GITHUB_OUTPUT
          echo "frontend_status=$(check_container docklift-frontend)" >> $GITHUB_OUTPUT
          echo "nginx_status=$(check_container docklift-nginx)" >> $GITHUB_OUTPUT
          echo "proxy_status=$(check_container docklift-nginx-proxy)" >> $GITHUB_OUTPUT
          
          if [ -d "/opt/docklift" ]; then
            echo "dir_exists=true" >> $GITHUB_OUTPUT
            VERSION=$(grep -o '"version": *"[^"]*"' /opt/docklift/backend/package.json 2>/dev/null | head -1 | cut -d'"' -f4 || echo "Unknown")
            echo "version=$VERSION" >> $GITHUB_OUTPUT
          else
            echo "dir_exists=false" >> $GITHUB_OUTPUT
            echo "version=Unknown" >> $GITHUB_OUTPUT
          fi

      - name: Generate Summary
        if: always()
        run: |
          if [ "${{ steps.install.outputs.exit_code }}" = "0" ]; then
            STATUS_EMOJI="âœ…"
            STATUS_TEXT="Success"
          else
            STATUS_EMOJI="âŒ"
            STATUS_TEXT="Failed"
          fi
          
          cat >> $GITHUB_STEP_SUMMARY << EOF
          # ðŸ“‹ Docklift Installation Test Summary
          
          ## $STATUS_EMOJI Overall Status: $STATUS_TEXT
          
          ### ðŸ“¦ Version Info
          - **Version:** \`${{ steps.verify.outputs.version }}\`
          - **Path:** \`/opt/docklift\`
          - **Status:** $([ "${{ steps.verify.outputs.dir_exists }}" == "true" ] && echo "âœ… Directory created" || echo "âŒ Directory missing")
          
          ### â±ï¸ Timing
          | Step | Duration |
          |------|----------|
          | Environment Setup | ${{ steps.setup.outputs.duration }}s |
          | Install Script | ${{ steps.install.outputs.duration }}s |
          
          ### ðŸ³ Container Status
          | Service | Status |
          |---------|--------|
          | Backend | ${{ steps.verify.outputs.backend_status }} |
          | Frontend | ${{ steps.verify.outputs.frontend_status }} |
          | Web UI (8080) | ${{ steps.verify.outputs.nginx_status }} |
          | Reverse Proxy (80) | ${{ steps.verify.outputs.proxy_status }} |
          
          EOF
          
          if [ "${{ steps.install.outputs.exit_code }}" != "0" ]; then
            echo "### âŒ Error Logs (Last 50 lines)" >> $GITHUB_STEP_SUMMARY
            echo '```bash' >> $GITHUB_STEP_SUMMARY
            tail -50 install_output.txt >> $GITHUB_STEP_SUMMARY || echo "No output captured" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "_Generated by Docklift CI â€¢ $(date -u '+%Y-%m-%d %H:%M UTC')_" >> $GITHUB_STEP_SUMMARY

      - name: Fail if install failed
        if: steps.install.outputs.exit_code != '0'
        run: exit 1
