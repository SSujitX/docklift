name: Test Install - Ubuntu

on:
  push:
    branches: [ master, main ]
  pull_request:
    branches: [ master, main ]
  workflow_dispatch:

jobs:
  test-ubuntu:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Setup Environment
        id: setup
        run: |
          START_TIME=$(date +%s)
          sudo apt-get update
          sudo apt-get install -y curl sudo
          END_TIME=$(date +%s)
          echo "duration=$((END_TIME - START_TIME))" >> $GITHUB_OUTPUT

      - name: Run Install Script
        id: install
        run: |
          START_TIME=$(date +%s)
          chmod +x install.sh
          sudo DOCKLIFT_CI_LOCAL=true ./install.sh 2>&1 | tee install_output.txt
          EXIT_CODE=${PIPESTATUS[0]}
          END_TIME=$(date +%s)
          echo "duration=$((END_TIME - START_TIME))" >> $GITHUB_OUTPUT
          echo "exit_code=$EXIT_CODE" >> $GITHUB_OUTPUT
          exit $EXIT_CODE
        env:
          CI: true
        continue-on-error: true

      - name: Verify Installation
        id: verify
        run: |
          BACKEND_STATUS="âš ï¸ Not Running"
          FRONTEND_STATUS="âš ï¸ Not Running"
          NGINX_STATUS="âš ï¸ Not Running"
          
          if [ -d "/opt/docklift" ]; then
            echo "dir_exists=true" >> $GITHUB_OUTPUT
          else
            echo "dir_exists=false" >> $GITHUB_OUTPUT
          fi
          
          if sudo docker ps | grep -q "docklift-backend"; then
            BACKEND_STATUS="âœ… Running"
            echo "backend_running=true" >> $GITHUB_OUTPUT
          fi
          
          if sudo docker ps | grep -q "docklift-frontend"; then
            FRONTEND_STATUS="âœ… Running"
            echo "frontend_running=true" >> $GITHUB_OUTPUT
          fi
          
          if sudo docker ps | grep -q "docklift-nginx"; then
            NGINX_STATUS="âœ… Running"
            echo "nginx_running=true" >> $GITHUB_OUTPUT
          fi
          
          echo "backend_status=$BACKEND_STATUS" >> $GITHUB_OUTPUT
          echo "frontend_status=$FRONTEND_STATUS" >> $GITHUB_OUTPUT
          echo "nginx_status=$NGINX_STATUS" >> $GITHUB_OUTPUT

      - name: Generate Summary
        if: always()
        run: |
          # Determine overall status
          if [ "${{ steps.install.outputs.exit_code }}" = "0" ]; then
            STATUS_EMOJI="âœ…"
            STATUS_TEXT="Success"
          else
            STATUS_EMOJI="âŒ"
            STATUS_TEXT="Failed"
          fi
          
          # Build summary
          cat >> $GITHUB_STEP_SUMMARY << 'EOF'
          # ðŸ“‹ Docklift Installation Test Summary
          
          EOF
          
          echo "## $STATUS_EMOJI Overall: $STATUS_TEXT" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          echo "### â±ï¸ Timing" >> $GITHUB_STEP_SUMMARY
          echo "| Step | Duration |" >> $GITHUB_STEP_SUMMARY
          echo "|------|----------|" >> $GITHUB_STEP_SUMMARY
          echo "| Environment Setup | ${{ steps.setup.outputs.duration }}s |" >> $GITHUB_STEP_SUMMARY
          echo "| Install Script | ${{ steps.install.outputs.duration }}s |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          echo "### ðŸ³ Container Status" >> $GITHUB_STEP_SUMMARY
          echo "| Service | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|---------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Backend | ${{ steps.verify.outputs.backend_status }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Frontend | ${{ steps.verify.outputs.frontend_status }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Nginx Proxy | ${{ steps.verify.outputs.nginx_status }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          echo "### ðŸ“ Installation" >> $GITHUB_STEP_SUMMARY
          if [ "${{ steps.verify.outputs.dir_exists }}" = "true" ]; then
            echo "- âœ… Directory created: \`/opt/docklift\`" >> $GITHUB_STEP_SUMMARY
          else
            echo "- âŒ Directory missing: \`/opt/docklift\`" >> $GITHUB_STEP_SUMMARY
          fi
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Add errors if install failed
          if [ "${{ steps.install.outputs.exit_code }}" != "0" ]; then
            echo "### âŒ Errors" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            tail -50 install_output.txt >> $GITHUB_STEP_SUMMARY || echo "No output captured" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "_Generated by Docklift CI â€¢ $(date -u '+%Y-%m-%d %H:%M UTC')_" >> $GITHUB_STEP_SUMMARY

      - name: Fail if install failed
        if: steps.install.outputs.exit_code != '0'
        run: exit 1
